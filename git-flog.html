<!DOCTYPE html> 
<html>
<meta charset="UTF-8">
<style>
.toggle {
    margin-right: 0.25em;
}

.block {
    display: block;
}

.inline {
    display: inline;
}

.hidden {
    display: none !important;
}

.github-avatar {
    height: 1em;
}

.popupcontent {
    visibility: hidden;
    position: absolute;
    z-index: -1;
    color: WindowText;
    background-color: Window;
    border: 1px solid ActiveBorder;
}

.popupcontentshow {
    visibility: visible;
    z-index: 1;
}

li:target > .desc {
    background-color: orange;
}
</style>
<script>
function Github(repository) {
    this.activate = function() {
        elShow("github");
        this.githubSetAuthType();
    }
    this.githubInitAuth = function() {
        if (this.auth == null) {
            if (this.request != null) {
                throw "Busy";
            }
            this.request = new XMLHttpRequest();
            var username = document.getElementById("github:username").value;
            var password = document.getElementById("github:password").value.trim();
            if (/^[a-f0-9]{40}$/.exec(password) == null) {
                alert("Please use the API token. Aren't you trying to use password?");
                this.request = null;
            } else if (username != null && username.length > 0 && password != null && password.length > 0) {
                this.request.open("GET", "https://api.github.com/user", true);
                this.request.setRequestHeader("Authorization", "Basic " + window.btoa(username + ":" + password));
                var ghThis = this;
                this.request.onreadystatechange = function() {
                    if (ghThis.request.readyState == 4) {
                        document.getElementById("info").textContent = ghThis.request.getAllResponseHeaders();
                        if (ghThis.request.status == 200) {
                            ghThis.auth = [username, password];
                            var info = JSON.parse(ghThis.request.responseText);
                            document.getElementById("github:userinfo:name").textContent = info["login"];
                            document.getElementById("github:userinfo:name").setAttribute("href", info["html_url"]);
                            document.getElementById("github:userinfo:avatar").setAttribute("src", info["avatar_url"]);
                            elShow("github:userinfo");
                            elHide("github:login");
                            elHide("github:authtype");
                        }
                        ghThis.request = null;
                    }
                }
                this.request.send();
            } else {
                this.request = null;
            }
        }
    }
    // make refs here to have only one in heap
    var urlPrefix = "https://github.com/" + repository + "/commit/";
    var makeUrl = function(h) { return urlPrefix + h; };
    this.getMoreCommits = function(handleCommit) {
        if (this.request != null) {
            throw "Busy";
        }
        if (this.nextUrl == null) {
            throw "Nothing to get more";
        }
        this.request = new XMLHttpRequest();
        this.request.open("GET", this.nextUrl, true);
        if (this.auth != null) {
            this.request.setRequestHeader("Authorization", "Basic " + window.btoa(this.auth[0] + ":" + this.auth[1]));
        }
        var ghThis = this;
        this.request.onreadystatechange = function() {
            if (ghThis.request.readyState == 4) {
                document.getElementById("info").textContent = ghThis.request.getAllResponseHeaders();
                if (ghThis.request.status == 200) {
                    var cs = JSON.parse(ghThis.request.responseText);
                    cs.forEach(function(c){
                        var desc = [c.commit.author.email, c.commit.message.split("\n")[0]];
                        handleCommit(c.sha,desc,c.parents.map(function(p) { return p.sha } ),makeUrl);
                    });
                    var nextUrl = null;
                    if (ghThis.request.getResponseHeader("link").split(",").some(function (link) {
                            var cs = link.split(";");
                            if (/^\s*rel="next"\s*$/.test(cs[1])) {
                                var urlPattern = /^\s*<(https:\/\/api\.github\.com\/repositories\/[0-9]+\/commits\?sha\=[a-z0-9_\/%-]+\&per_page\=[0-9]+\&page\=[0-9]+)>$/i;
                                nextUrl = urlPattern.exec(cs[0])[1];
                                return true;
                            } else {
                                return false;
                            }
                        })) {
                        ghThis.nextUrl = nextUrl;
                        elShow("continue");
                    } else {
                        ghThis.nextUrl = null;
                        elHide("continue");
                    }
                }
                ghThis.request = null;
            }
        }
        this.request.send();
    }
    this.githubSetAuthType = function() {
        switch (document.getElementById("github:authtype").value) {
        case "noauth":
            elHide("github:auth");
            break;
        case "token":
            elShow("github:auth");
            break;
        }
    }

    this.request = null;
    this.auth = null;
    // TODO:
    // * use custom branch
    // * select first chunk at auth
    this.nextUrl = "https://api.github.com/repos/" + repository + "/commits?sha=master&per_page=100";
    this.repository = repository;
}
function githubTry(url) {
    var match = /^(https:\/\/github\.com\/|git@githu\.com:|git:\/\/github\.com\/)([^\/]+)\/([^\/]+)($|\.git|\/)/i.exec(url);
    if (match != null) {
        return new Github(match[2] + "/" + match[3]);
    } else {
        return null;
    }
}
Github.initAuth = function() {
    window.state.handler.githubInitAuth();
}
Github.setAuthType = function() {
    window.state.handler.githubSetAuthType();
}
function statePrototype(handler) {
    this.pickCommit = function(hash) {
        if (hash in this.commits) {
            return this.commits[hash];
        } else {
            var c = new commit(hash);
            this.commits[hash] = c;
            return c;
        }
    }
    this.addCommit = function(hash,desc,parents,makeUrl) {
        var c = this.pickCommit(hash);
        if (c.info != null) {
            // duplicate; nothing to do
            return;
        }
        var parent_objects = parents.map(function(p){ return this.pickCommit(p); }, this);
        c.info = new commitInfo(desc,parent_objects,makeUrl);
        c.sortParents();

    }
    this.getMoreCommits = function() {
        var sThis = this;
        this.handler.getMoreCommits(function(h,d,p,m) { sThis.addCommit(h,d,p,m) });
    }

    this.commits = {};
    this.handler = handler;
}
function scoreGT(s1, s2) {
    var l = (s1.length > s2.length) ? s2.length : s1.length;
    for (var i = 0; i < l; ++i) {
        if (s1[i] > s2[i]) {
            return true;
        } else if (s1[i] < s2[i]) {
            return false;
        }
    }
    if (s1.length > s2.length) {
        return true;
    } else {
        return false;
    }
}
function commit(hash, makeUrl) {
    this.sortParents = function() {
        if (this.info == null) {
            return;
        }
        var pl = this.info.parents.length;
        var handleParent = function(treeParent,p,pscore){
            if (scoreGT(pscore,p.score)) {
                p.score = pscore;
                p.treeParent = treeParent;
                p.sortParents();
            }
        }
        var nextscore = this.score.concat();
        ++nextscore[nextscore.length - 1];
        handleParent(this.treeParent,this.info.parents[0], nextscore);
        // ignore next parents so far
        // TODO: make the intermediate fake "commit"
        if (pl > 1) {
            handleParent(this,this.info.parents[1], this.score.concat([1]));
        }

        // TODO: bring this separately this
        if (this.domSelf != null) {
            document.getElementById("commits").removeChild(this.domSelf);
            this.domSelf = null;
        }
        this.domSelf = document.createElement("li");
        this.domSelf.id = "li:" + this.hash;
        this.domSelf.innerHTML = '<a class="desc"></a><span></span>';
        // this.domSelf.childNodes[0].setAttribute("href", this.info.makeUrl(this.hash));
        this.domSelf.childNodes[0].setAttribute("onclick", 'showInfoPopup("' + this.hash + '")');
        this.domSelf.childNodes[0].textContent = this.info.desc[0] + ": " + this.info.desc[1];
        this.domSelf.childNodes[1].textContent = JSON.stringify(this.score);
        var base = (this.treeParent == null) ? document.getElementById("commits")
                    : this.treeParent.pickSublist();
        base.appendChild(this.domSelf);
    }
    this.pickSublist = function() {
        if (this.domSelf == null) {
            return null;
        }

        if (this.domSublist != null) {
            return this.domSublist;
        }
        this.domToggle = document.createElement("a");
        this.domToggle.textContent = "[>]";
        // this.domToggle.setAttribute("id", "tg:" + this.hash);
        this.domToggle.setAttribute("href", "javascript:state.commits[\"" + this.hash + "\"].toggle();");
        this.domToggle.setAttribute("class", "toggle");
        this.domSelf.insertBefore(this.domToggle, this.domSelf.childNodes[0]);
        this.domSublist = document.createElement("ul");
        // this.domSublist.setAttribute("id", "ul:" + this.hash);
        this.domSelf.appendChild(this.domSublist);
        this.domSublist.setAttribute("hidden", "")
        return this.domSublist;
    }
    this.toggle = function() {
        if (this.domSublist == null) {
            throw "sublist not defined: " + this.hash;
        }
        if (this.domSublist.hasAttribute("hidden")) {
            this.domSublist.removeAttribute("hidden");
            this.domToggle.textContent = "[v]";
        } else {
            this.domSublist.setAttribute("hidden", "");
            this.domToggle.textContent = "[>]";
        }
    }

    this.hash = hash;
    this.score = [1];
    this.children = [];
    this.treeParent = null;
    this.info = null;
    this.domSelf = null;
    this.domSublist = null;
    this.domToggle = null;
    this.domLinks = [];
}
function commitInfo(desc, parents,makeUrl) {
    this.desc = desc;
    this.parents = parents;
    this.makeUrl = makeUrl;
}
var state = null;
function uiStart() {
    var handler = null;
    var url = document.getElementById("start:url").value;
    if ([githubTry].some(function (h) { handler = h(url); return (handler != null) })) {
        elHide("start");
        handler.activate();
    }
    window.state = new statePrototype(handler);
}
function uiGithubAuthTypeChanged() {
    // TODO: move into github, make it consider current state
}
function uiContinue() {
    if (window.state == null) {
        throw "uiContinue(): Unexpected: state must be defined";
    }
    window.state.getMoreCommits();
}
function elShow(elName) {
    removeClassName(document.getElementById(elName), "hidden");
}
function elHide(elName) {
    addClassName(document.getElementById(elName), "hidden");
}
function addClassName(el, name) {
    var classes = el.className.split(" ");
    if (!classes.some(function(n) { return (n.trim() == name); })) {
        el.className += " " + name;
    } 
}
function removeClassName(el, name) {
    el.className = el.className
                    .split(" ")
                    .map(function (s) { return s.trim(); })
                    .filter(function (s) { return (s != name) })
                    .join(" ");
}
function showInfoPopup(hash) {
    var c = window.state.pickCommit(hash);
    document.getElementById("info-popup-hash").innerText = hash;
    document.getElementById("info-popup-hash").setAttribute("href", c.info.makeUrl(hash));
    document.getElementById("info-popup-author-name").innerText = c.info.desc[0];
    document.getElementById("info-popup-commit-message").innerText = c.info.desc[1];
    var p = document.getElementById("info-popup");
    p.classList.add("popupcontentshow");
    var li = document.getElementById("li:" + hash);
    li.appendChild(p);
}
</script>
<body>
<form id="start" class="block" action="javascript:uiStart();">
 <input id="start:url" type="text" name="url">
 <input type="submit" value="Show This Repository">
</form>
<div id="github" class="block hidden">
 Github login: <select id="github:authtype" onChange="Github.setAuthType();">
  <option value="noauth" selected>Anonymous</option>
  <option value="token">Token login</option>
 </select>
 <div id="github:auth" class="inline hidden">
  <form id="github:login" action="javascript:Github.initAuth();" class="inline">
   User: <input id="github:username" type="text" name="username">
   Token: <input id="github:password" type="password" name="token">
   <input type="submit" value="Login"> (<a href="https://github.com/settings/tokens/new?scopes=&description=git-flog%20token" target="_blank">Get token</a>)
  </form>
  <form id="github:userinfo" class="inline hidden">
   <img id="github:userinfo:avatar" src="" class="github-avatar"> <a id="github:userinfo:name" href="" target="_blank"></a>
  </form>
 </div>
</div>
<ul id="commits"></ul>
<form id="continue" action="javascript:uiContinue();">
 <input type="submit" value="Continue"> <!-- TODO: properly show it -->
</form>
<pre id="info"></pre>
<div class="popupcontent" id="info-popup">
<p><a href="" id="info-popup-hash"></a></p>
<p>Author:
    <a href="" id="info-popup-author">
        <img src="" id="info-popup-author-icon">
        <span id="info-popup-author-name"></span>
    </a><span id="info-popup-author-time"></span></p>
<!-- <p>Committer:
    <a href="" id="info-popup-committer">
        <img src="" id="info-popup-committer-icon">
        <span id="info-popup-committer-name"></span>
    </a><span id="info-popup-committer-time"></span></p> -->
<pre id="info-popup-commit-message">
</pre>
</div>
</body>
</html>
