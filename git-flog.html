<!DOCTYPE html> 
<html>
<meta charset="UTF-8">
<style>
.toggle {
    margin-right: 0.25em;
}

li:target > .desc {
    background-color: orange;
}
</style>
<script>
function Github(repository) {
    this.activate = function() {
        document.getElementById("github").removeAttribute("hidden");
    }

    this.repository = repository;
}
function githubTry(url) {
    var match = /^(https:\/\/github\.com\/|git@githu\.com:|git:\/\/github\.com\/)([^\/]+)\/([^\/]+)($|\.git|\/)/i.exec(url);
    if (match != null) {
        return new Github(match[2] + "/" + match[3]);
    } else {
        return null;
    }
}
function statePrototype(auth) {
    this.pickCommit = function(hash) {
        if (hash in this.commits) {
            return this.commits[hash];
        } else {
            var c = new commit(hash);
            this.commits[hash] = c;
            return c;
        }
    }
    this.addCommit = function(hash,desc,parents) {
        var c = this.pickCommit(hash);
        if (c.info != null) {
            // duplicate; nothing to do
            return;
        }
        var parent_objects = parents.map(function(p){ return this.pickCommit(p); }, this);
        c.info = new commitInfo(desc,parent_objects);
        c.sortParents();

    }
    this.getCommits = function (url) {
        var xmlhttp = new XMLHttpRequest();
        var thisState = this;
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4) {
                document.getElementById("info").textContent = xmlhttp.getAllResponseHeaders();
                if (xmlhttp.status == 200) {
                    addCommits(thisState,xmlhttp.responseText);
                    var nextUrl = null;
                    if (xmlhttp.getResponseHeader("link").split(",").some(function (link) {
                            var cs = link.split(";");
                            if (/^\s*rel="next"\s*$/.test(cs[1])) {
                                var urlPattern = /^\s*<(https:\/\/api\.github\.com\/repositories\/[0-9]+\/commits\?sha\=[a-z0-9_\/%-]+\&per_page\=[0-9]+\&page\=[0-9]+)>$/i;
                                nextUrl = urlPattern.exec(cs[0])[1];
                                return true;
                            } else {
                                return false;
                            }
                        })) {
                        thisState.moreUrl = nextUrl;
                        document.getElementById("continue").removeAttribute("hidden");
                    } else {
                        thisState.moreUrl = null;
                        document.getElementById("continue").setAttribute("hidden", "");
                    }
                }
            }
        }
        xmlhttp.open("GET", url, true);
        if (this.auth != null) {
            xmlhttp.setRequestHeader("Authorization", "Basic " + window.btoa(this.auth[0] + ":" + this.auth[1]));
        }
        xmlhttp.send();
    }
    this.getMoreCommits = function() {
        this.getCommits(this.moreUrl);
    }
    this.addCommits = function(json) {
        var cs = JSON.parse(json);
        cs.forEach(function(c){
            var desc = c.commit.author.email + ": " + c.commit.message.split("\n")[0];
            this.addCommit(c.sha,desc,c.parents.map(function(p) { return p.sha } ));
        });
    }

    this.commits = {};
    this.auth = auth;
    this.moreUrl = null;
}
function scoreGT(s1, s2) {
    var l = (s1.length > s2.length) ? s2.length : s1.length;
    for (var i = 0; i < l; ++i) {
        if (s1[i] > s2[i]) {
            return true;
        } else if (s1[i] < s2[i]) {
            return false;
        }
    }
    if (s1.length > s2.length) {
        return true;
    } else {
        return false;
    }
}
function commit(hash) {
    this.sortParents = function() {
        if (this.info == null) {
            return;
        }
        var pl = this.info.parents.length;
        var handleParent = function(treeParent,p,pscore){
            if (scoreGT(pscore,p.score)) {
                p.score = pscore;
                p.treeParent = treeParent;
                p.sortParents();
            }
        }
        var nextscore = this.score.concat();
        ++nextscore[nextscore.length - 1];
        handleParent(this.treeParent,this.info.parents[0], nextscore);
        // ignore next parents so far
        // TODO: make the intermediate fake "commit"
        if (pl > 1) {
            handleParent(this,this.info.parents[1], this.score.concat([1]));
        }

        // TODO: bring this separately this
        if (this.domSelf != null) {
            document.getElementById("commits").removeChild(this.domSelf);
            this.domSelf = null;
        }
        this.domSelf = document.createElement("li");
        this.domSelf.id = "li:" + this.hash;
        var a = document.createElement("a");
        a.className = "desc";
        a.setAttribute("href", "https://github.com/git/git/commit/" + hash);
        a.appendChild(document.createTextNode(this.info.desc));
        this.domSelf.appendChild(a);
        this.domSelf.appendChild(document.createTextNode(JSON.stringify(this.score)));
        var base = (this.treeParent == null) ? document.getElementById("commits")
                    : this.treeParent.pickSublist();
        base.appendChild(this.domSelf);
    }
    this.pickSublist = function() {
        if (this.domSelf == null) {
            return null;
        }

        if (this.domSublist != null) {
            return this.domSublist;
        }
        this.domToggle = document.createElement("a");
        this.domToggle.textContent = "[>]";
        // this.domToggle.setAttribute("id", "tg:" + this.hash);
        this.domToggle.setAttribute("href", "javascript:state.commits[\"" + this.hash + "\"].toggle();");
        this.domToggle.setAttribute("class", "toggle");
        this.domSelf.insertBefore(this.domToggle, this.domSelf.childNodes[0]);
        this.domSublist = document.createElement("ul");
        // this.domSublist.setAttribute("id", "ul:" + this.hash);
        this.domSelf.appendChild(this.domSublist);
        this.domSublist.setAttribute("hidden", "")
        return this.domSublist;
    }
    this.toggle = function() {
        if (this.domSublist == null) {
            throw "sublist not defined: " + this.hash;
        }
        if (this.domSublist.hasAttribute("hidden")) {
            this.domSublist.removeAttribute("hidden");
            this.domToggle.textContent = "[v]";
        } else {
            this.domSublist.setAttribute("hidden", "");
            this.domToggle.textContent = "[>]";
        }
    }

    this.hash = hash;
    this.score = [1];
    this.children = [];
    this.treeParent = null;
    this.info = null;
    this.domSelf = null;
    this.domSublist = null;
    this.domToggle = null;
    this.domLinks = [];
}
function commitInfo(desc, parents) {
    this.desc = desc;
    this.parents = parents;
}
var state = null;
function uiStart() {
    var handler = null;
    var url = document.getElementById("start:url").value;
    if ([githubTry].some(function (h) { handler = h(url); return (handler != null) })) {
        document.getElementById("start").setAttribute("hidden", "");
        handler.activate();
    }
}
function uiGithubAuthTypeChanged() {
    switch (document.getElementById("github:authtype").value) {
    case "noauth":
        document.getElementById("github:auth").setAttribute("hidden", "");
        break;
    case "token":
        document.getElementById("github:auth").removeAttribute("hidden");
        break;
    }
}
function uiGetCommits() {
    if (window.state == null) {
        var auth = null;
        var username = document.getElementById("start:username").value;
        var password = document.getElementById("start:password").value;
        if (username != null && username.length > 0 && password != null && password.length > 0) {
            auth = [username, password];
        }
        window.state = new statePrototype(auth);
    }
    window.state.getCommits("https://api.github.com/repos/git/git/commits?sha=master&per_page=100");
    document.getElementById("start").setAttribute("hidden", "");
}
function uiContinue() {
    if (window.state == null) {
        throw "uiContinue(): Unexpected: state must be defined";
    }
    window.state.getMoreCommits();
}
</script>
<body>
<form id="start" action="javascript:uiStart();">
 <input id="start:url" type="text" name="url">
 <input type="submit" value="Show This Repository">
</form>
<div id="github" hidden>
 Github login: <select id="github:authtype" onChange="uiGithubAuthTypeChanged();">
  <option value="noauth">Anonymous</option>
  <option value="token">Token login</option>
 </select>
 <form id="github:auth" action="javascript:Github.initAuth();" hidden>
  User: <input id="github:username" type="text" name="username">
  Token: <input id="github:password" type="password" name="token">
  <input type="submit" value="Get"> (<a href="https://github.com/settings/tokens/new">Get token (UNCHECK ALL SCOPES)</a>)
 </form>
</div>
<ul id="commits"></ul>
<form id="continue" action="javascript:uiContinue();" hidden>
 <input type="submit" value="Continue">
</form>
<pre id="info"></pre>
</body>
</html>
